<!-- /* Author CSF */ -->

<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/data.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
/>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://js.arcgis.com/4.28/"></script>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
  crossorigin="anonymous"
/>
<script src="portwatch-ais-charts.js"></script>
<link rel="stylesheet" type="text/css" href="portwatch-ais-charts.css" />

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"
></script>

<!-- <link rel="stylesheet" type="text/css" href="Highcharts-IMF.css"/> -->

<div class="card text-center">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs">
        <li class="nav-item" id="n">
          <a class="nav-link active" href="#">Transit Calls</a>
        </li>
        <li class="nav-item" id="capacity">
          <a class="nav-link" href="#">Transit Trade Volume</a>
        </li>
      </ul>
    </div>
    <div class="card-body">
        <figure class="highcharts-figure">
            <div id="container"></div>
            <div style="margin-right:12px">                 
              <p id="source" style="text-align:right;font-size:1vw;">Sources: UN Global Platform; PortWatch.</p> 
            </div>
        </figure>
    </div>
  </div>




<script>

var portsUrl = "https://services9.arcgis.com/weJ1QsnbMYJlCHdG/arcgis/rest/services/Daily_Chokepoints_Data/FeatureServer/0"


$(document).ready(function() {

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const portid = urlParams.get('portid');
    console.log(portid);

    
    queryAndChartData(portid);
});



    
var queryAndChartData = function (portid) {
    require(["esri/layers/FeatureLayer", "esri/rest/support/Query"], (
      FeatureLayer,
      Query
    ) => {
      const portLayer = new FeatureLayer({
        url: portsUrl,
      });
      const portQuery = new Query({
        where: "portid='" + portid + "'",
        outFields: "*",
        cacheHint: true,
        maxRecordCountFactor: 5,
      });

      async function executeDynamicQueries(portid) {
        const promises = [
          portLayer.queryFeatures(portQuery).then((result) => {
            return parseChokepoint(result.features);
          })
        ];
        const results = await Promise.all(promises);
        return results;
      }

      executeDynamicQueries(portid).then((results) => {
        [chokepoint] = results;
        const final = generateChokepointIndicators(chokepoint);

        createDisruptionAisChart(final, "n");

        $(".nav.nav-tabs.card-header-tabs > li").on("click", function (e) {
          $(".nav.nav-tabs.card-header-tabs > li > a").removeClass("active");
          $(this).children().addClass("active");
          const selected = $(this).attr("id");
          console.log(selected);
          createDisruptionAisChart(final, selected);
        });
      });
    });
  };


</script>
