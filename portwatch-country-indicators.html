<!-- /* Author CSF */ -->

<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/data.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
/>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://js.arcgis.com/4.28/"></script>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
  crossorigin="anonymous"
/>
<script src="portwatch-ais-charts.js"></script>

<link rel="stylesheet" type="text/css" href="portwatch-ais-charts.css" />

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"
></script>
<style>
  /*
  .not-show {
   display: none; 
  }*/
</style>

<div class="card text-center">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs">
      <li class="nav-item" id="portcalls">
        <a class="nav-link active" href="#">Port Calls</a>
      </li>
      <li class="nav-item" id="import">
        <a class="nav-link" href="#">Incoming Shipment</a>
      </li>
      <li class="nav-item" id="export">
        <a class="nav-link" href="#">Outgoing Shipment</a>
      </li>
      <li class="nav-item nowcast-tab" id="importN" style="display: none;">
        <a class="nav-link" href="#">Import Nowcast</a>
      </li>
      <li class="nav-item nowcast-tab" id="exportN" style="display: none;">
        <a class="nav-link" href="#">Export Nowcast</a>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <figure class="highcharts-figure">
      <div id="container"></div>
      <div style="margin-right: 12px; margin-left: 12px">
        <span class="source" style="float: left; font-size: 1vw"
          >Note: Latest data points are subject to revision.</span
        >
        <span
          class="source"
          style="float: right; text-align: right; font-size: 1vw"
          >Sources: UN Global Platform; PortWatch.</span
        >
      </div>
    </figure>
  </div>
</div>

<script>
  var countryUrl =
    "https://services9.arcgis.com/weJ1QsnbMYJlCHdG/arcgis/rest/services/Daily_Trade_Data_REG/FeatureServer/0";
  var eventsUrl =
    "https://services9.arcgis.com/weJ1QsnbMYJlCHdG/arcgis/rest/services/disruptions_with_ports/FeatureServer/0";
  var nowcastUrl =
    "https://services9.arcgis.com/weJ1QsnbMYJlCHdG/arcgis/rest/services/Monthly_TradeNow/FeatureServer/0";

  const ma_days = 30; // Use 30-day MA for this chart

  Highcharts.SVGRenderer.prototype.symbols.download = downloadSymbol;

  $(document).ready(function () {
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    var iso3 = urlParams.get("iso3");
    var version = urlParams.get("version");
    
    iso3 = iso3 == null ? "BRA" : iso3;
    version = version == null ? "simple" : version;

    // Show/hide nowcast tabs based on version
    if (version === "extended") {
      $(".nowcast-tab").show();
    }

    queryAndChartData(iso3, version);
  });

  var queryAndChartData = function (iso3, version) {
    require(["esri/layers/FeatureLayer", "esri/rest/support/Query"], (
      FeatureLayer,
      Query
    ) => {

      // Define Layers Connections
      const countryLayer = new FeatureLayer({
        url: countryUrl,
      });
      const nowcastLayer = new FeatureLayer({
        url: nowcastUrl,
      });

      // Define Data Queries
      const countryQuery = new Query({
        where: "ISO3='" + iso3 + "'",
        outFields: ['date', 'country', 'ISO3', 
        'portcalls_container', 'portcalls_dry_bulk', 'portcalls_general_cargo', 'portcalls_roro', 'portcalls_tanker', 'portcalls', 
        'import_container', 'import_dry_bulk', 'import_general_cargo', 'import_roro', 'import_tanker', 'import', 
        'export_container', 'export_dry_bulk', 'export_general_cargo', 'export_roro', 'export_tanker', 'export'],
        cacheHint: true,
        maxRecordCountFactor: 5,
      });
      const nowcastQuery = new Query({
        where: "ISO3='" + iso3 + "'",
        outFields: ['date', 'region', 'ISO3', 'value_import_total', 'value_export_total', 'volume_import_total', 'volume_export_total'],
        cacheHint: true,
        maxRecordCountFactor: 5,
      });

      async function executeDynamicQueries(iso3, version) {
        const promises = [
          countryLayer.queryFeatures(countryQuery).then((result) => {
            return parseCountry(result.features);
          })
        ];

        // Only fetch nowcast data if extended version
        if (version === "extended") {
          promises.push(
            nowcastLayer.queryFeatures(nowcastQuery).then((result) => {
              return result.features;
            })
          );
        }
        
        const results = await Promise.all(promises);
        return results;
      }

      executeDynamicQueries(iso3, version).then((results) => {
        let country, nowcast, nowcastData;
        
        if (version === "extended") {
          [country, nowcast] = results;
          nowcastData = generateNowcastSeries(nowcast);
        } else {
          [country] = results;
        }
        const final = generateIndicators(country, ma_days=ma_days);

        createDisruptionAisChart(final, "portcalls", ma_days=ma_days);

        $(".nav.nav-tabs.card-header-tabs > li").on("click", function (e) {
          $(".nav.nav-tabs.card-header-tabs > li > a").removeClass("active");
          $(this).children().addClass("active");
          const selected = $(this).attr("id");
          console.log(selected);
          if (["portcalls", "import", "export"].includes(selected)) {
            createDisruptionAisChart(final, selected, ma_days=ma_days);
          } else {
            createGrowthRateChart(nowcastData, selected);
          }
        });
      });
    });
  };
</script>
